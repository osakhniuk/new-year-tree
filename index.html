<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Shake Detection</title>
<style>
  body {
    font-family: sans-serif;
    padding: 20px;
  }
  #status {
    font-size: 24px;
    font-weight: bold;
  }
  #request-btn {
    padding: 10px 20px;
    font-size: 18px;
    margin-bottom: 20px;
    cursor: pointer;
  }
</style>
</head>
<body>
  <h1>Shake Detection in Telegram Mini App</h1>
  <button id="request-btn">Надати доступ до акселерометра</button>
  <div id="status">Shaking: false</div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const SHAKE_THRESHOLD = 15;
    let lastX = null;
    let lastY = null;
    let lastZ = null;
    let isShaking = false;
    let statusElement = document.getElementById('status');
    let requestBtn = document.getElementById('request-btn');

    function checkShake(ax, ay, az) {
      if (lastX === null || lastY === null || lastZ === null) {
        lastX = ax;
        lastY = ay;
        lastZ = az;
        return false;
      }

      let deltaX = Math.abs(ax - lastX);
      let deltaY = Math.abs(ay - lastY);
      let deltaZ = Math.abs(az - lastZ);

      lastX = ax;
      lastY = ay;
      lastZ = az;

      return (deltaX > SHAKE_THRESHOLD || deltaY > SHAKE_THRESHOLD || deltaZ > SHAKE_THRESHOLD);
    }

    function startListeningMotion() {
      window.addEventListener('devicemotion', (event) => {
        let acceleration = event.accelerationIncludingGravity;
        if (!acceleration) return; 
      
        let { x, y, z } = acceleration;

        isShaking = checkShake(x, y, z);
        statusElement.textContent = 'Shaking: ' + isShaking;
      }, true);
    }

    // Запитуємо дозвіл при кліку на кнопку
    requestBtn.addEventListener('click', async () => {
      if (typeof DeviceMotionEvent !== 'undefined' 
          && typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
          const response = await DeviceMotionEvent.requestPermission();
          if (response === 'granted') {
            startListeningMotion();
            requestBtn.style.display = 'none';
          } else {
            alert('Доступ до акселерометра не надано');
          }
        } catch (e) {
          console.error(e);
          alert('Помилка при спробі отримати доступ до акселерометра');
        }
      } else {
        // Якщо requestPermission не підтримується, просто слухаємо подію одразу (наприклад, на Android)
        startListeningMotion();
        requestBtn.style.display = 'none';
      }
    });

    // Ініціалізація Telegram WebApp
    Telegram.WebApp.ready();
  </script>
</body>
</html>
